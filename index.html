<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>üéØ Reflexions-Radar Mobile v5.4.9-M</title>
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --glass-bg: rgba(255,255,255,0.1);
            --glass-border: rgba(255,255,255,0.2);
            --stress-0: #9E9E9E;
            --stress-1: #4CAF50;
            --stress-2: #8BC34A;
            --stress-3: #FFC107;
            --stress-4: #FF9800;
            --stress-5: #F44336;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { 
            background: var(--primary-gradient); 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            overflow: hidden; 
            height: 100vh; 
            width: 100vw;
            position: fixed;
            user-select: none; 
            -webkit-user-select: none;
            touch-action: none;
        }
        
        /* HEADER */
        .header { 
            position: fixed; 
            top: 0; 
            left: 0; 
            right: 0; 
            height: 60px; 
            background: rgba(0,0,0,0.9); 
            backdrop-filter: blur(20px); 
            display: flex; 
            align-items: center; 
            justify-content: space-between;
            padding: 0 15px; 
            z-index: 1000; 
            border-bottom: 2px solid var(--glass-border); 
            box-shadow: 0 2px 20px rgba(0,0,0,0.5); 
        }
        .header h1 { 
            color: white; 
            font-size: 18px; 
            font-weight: 700;
            flex: 1;
        }
        .header-stats { 
            display: flex; 
            gap: 8px; 
            font-size: 11px;
        }
        .stat { 
            color: white; 
            background: rgba(0,0,0,0.5); 
            padding: 4px 8px; 
            border-radius: 8px; 
            font-weight: 600; 
        }
        
        /* POSITION MODE BANNER */
        .position-mode-banner {
            position: fixed;
            top: 60px;
            left: 0;
            right: 0;
            height: 50px;
            background: rgba(255,193,7,0.95);
            backdrop-filter: blur(20px);
            display: none;
            align-items: center;
            justify-content: space-between;
            padding: 0 15px;
            z-index: 999;
            color: #000;
            font-weight: 700;
            font-size: 14px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.3);
        }
        .position-mode-banner.active {
            display: flex;
        }
        .cancel-position-btn {
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 13px;
            border: 2px solid rgba(255,255,255,0.3);
            cursor: pointer;
        }
        .cancel-position-btn:active {
            transform: scale(0.95);
        }
        
        /* BOTTOM TOOLBAR */
        .bottom-toolbar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 70px;
            background: rgba(0,0,0,0.95);
            backdrop-filter: blur(20px);
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 10px;
            z-index: 1000;
            border-top: 2px solid var(--glass-border);
            box-shadow: 0 -2px 20px rgba(0,0,0,0.5);
        }
        .tool-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-width: 60px;
            min-height: 50px;
            color: white;
            background: rgba(255,255,255,0.1);
            border-radius: 12px;
            font-size: 24px;
            transition: all 0.2s ease;
            border: 2px solid transparent;
            cursor: pointer;
        }
        .tool-btn:active {
            background: rgba(255,255,255,0.3);
            transform: scale(0.95);
        }
        .tool-label {
            font-size: 9px;
            margin-top: 4px;
            font-weight: 600;
        }
        
        /* CANVAS */
        #canvas { 
            position: absolute; 
            top: 60px; 
            left: 0; 
            right: 0; 
            bottom: 70px; 
            overflow: hidden; 
            background: radial-gradient(circle at 50% 50%, rgba(255,255,255,0.05) 0%, transparent 70%); 
            touch-action: none;
        }
        #canvas.position-mode {
            top: 110px;
            cursor: crosshair;
        }
        #canvasContent { 
            transform-origin: 0 0; 
            position: relative; 
            width: 100%; 
            height: 100%; 
        }
        #connectionsSvg { 
            position: absolute; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            pointer-events: none; 
            z-index: 2; 
        }
        #connectionsSvg line { 
            stroke-width: 5; 
            stroke-linecap: round; 
            opacity: 0.85; 
        }
        
        /* CONNECTION EMOJI */
        .connection-emoji { 
            position: absolute; 
            font-size: 28px; 
            background: linear-gradient(145deg, rgba(0,0,0,0.95), rgba(0,0,0,0.85)); 
            border-radius: 50%; 
            width: 56px; 
            height: 56px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            z-index: 5; 
            transform: translate(-50%, -50%); 
            border: 3px solid rgba(255,255,255,0.6); 
            box-shadow: 0 4px 15px rgba(0,0,0,0.5); 
            pointer-events: auto; 
            cursor: pointer;
        }
        .connection-emoji:active {
            transform: translate(-50%, -50%) scale(0.9);
        }
        
        /* MEMBERS */
        .member { 
            position: absolute; 
            width: 110px; 
            height: 110px; 
            border-radius: 50%; 
            color: white; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            font-size: 13px; 
            text-align: center; 
            box-shadow: 0 6px 20px rgba(0,0,0,0.4); 
            user-select: none; 
            touch-action: none; 
            border: 3px solid rgba(255,255,255,0.3); 
            backdrop-filter: blur(5px); 
            z-index: 10; 
            transition: transform 0.1s ease;
            cursor: move;
        }
        .member.dragging { 
            transform: scale(1.15); 
            z-index: 50; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.6);
        }
        .member.self { 
            border-color: #FFD700; 
            box-shadow: 0 0 20px rgba(255,215,0,0.6), 0 6px 20px rgba(0,0,0,0.4); 
        }
        .member.being-positioned {
            border-color: #FFC107;
            border-width: 5px;
            box-shadow: 0 0 30px rgba(255,193,7,0.8), 0 8px 25px rgba(0,0,0,0.5);
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.08); }
        }
        .member-name { 
            font-weight: 700; 
            margin-bottom: 4px; 
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8); 
            font-size: 12px; 
            padding: 0 5px; 
        }
        .stress-indicator { 
            background: rgba(0,0,0,0.7); 
            padding: 6px 10px; 
            border-radius: 10px; 
            font-size: 11px; 
            border: 1px solid rgba(255,255,255,0.4); 
            font-weight: 600; 
            min-width: 55px;
            min-height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .member-menu-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 28px;
            height: 28px;
            background: rgba(0,0,0,0.8);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: 700;
            color: white;
            z-index: 15;
            border: 2px solid rgba(255,255,255,0.5);
            cursor: pointer;
        }
        .member-menu-btn:active {
            transform: scale(0.9);
            background: rgba(0,0,0,1);
        }
        .notes-badge { 
            position: absolute; 
            top: -5px; 
            left: -5px; 
            width: 30px; 
            height: 30px; 
            background: rgba(255,193,7,0.9); 
            border-radius: 50%; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 18px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.3); 
            border: 2px solid rgba(255,255,255,0.8); 
            z-index: 15; 
        }
        .stress-0 { background: linear-gradient(135deg, #9E9E9E, #757575) !important; }
        .stress-1 { background: linear-gradient(135deg, #4CAF50, #388E3C) !important; }
        .stress-2 { background: linear-gradient(135deg, #8BC34A, #689F38) !important; }
        .stress-3 { background: linear-gradient(135deg, #FFC107, #FFA000) !important; }
        .stress-4 { background: linear-gradient(135deg, #FF9800, #F57C00) !important; }
        .stress-5 { background: linear-gradient(135deg, #F44336, #D32F2F) !important; }
        
        /* DRAWER */
        .drawer-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 1500;
            display: none;
        }
        .drawer {
            position: fixed;
            left: 0;
            right: 0;
            bottom: 0;
            max-height: 85vh;
            background: rgba(0,0,0,0.95);
            backdrop-filter: blur(25px);
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            padding: 20px;
            z-index: 1600;
            transform: translateY(100%);
            transition: transform 0.3s ease;
            overflow-y: auto;
            color: white;
        }
        .drawer.open {
            transform: translateY(0);
        }
        .drawer-handle {
            width: 40px;
            height: 4px;
            background: rgba(255,255,255,0.3);
            border-radius: 2px;
            margin: 0 auto 20px;
        }
        .drawer h3 {
            text-align: center;
            margin-bottom: 20px;
            font-size: 20px;
        }
        
        /* BUTTONS */
        .btn {
            background: var(--glass-bg);
            border: 2px solid var(--glass-border);
            color: white;
            padding: 14px 20px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            width: 100%;
            margin: 8px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            min-height: 50px;
            transition: all 0.2s ease;
            cursor: pointer;
        }
        .btn:active {
            background: rgba(255,255,255,0.2);
            transform: scale(0.98);
        }
        .btn:disabled {
            opacity: 0.5;
        }
        
        /* CONTEXT MENU */
        .context-menu {
            position: fixed;
            left: 10px;
            right: 10px;
            bottom: 80px;
            background: rgba(20,20,20,0.98);
            backdrop-filter: blur(25px);
            border-radius: 15px;
            padding: 10px;
            z-index: 1700;
            display: none;
            border: 2px solid var(--glass-border);
            box-shadow: 0 10px 30px rgba(0,0,0,0.7);
            max-height: 70vh;
            overflow-y: auto;
        }
        .context-item {
            padding: 16px;
            color: white;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            font-weight: 500;
            border-radius: 10px;
            min-height: 50px;
            transition: background 0.2s ease;
            cursor: pointer;
        }
        .context-item:active {
            background: rgba(255,255,255,0.1);
        }
        .context-item-label {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .context-item-value {
            opacity: 0.7;
            font-size: 14px;
        }
        .context-submenu {
            display: none;
            padding-left: 20px;
        }
        .context-submenu.open {
            display: block;
        }
        .submenu-item {
            padding: 12px 16px;
            color: white;
            font-size: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            border-radius: 8px;
            min-height: 45px;
            cursor: pointer;
        }
        .submenu-item:active {
            background: rgba(255,255,255,0.1);
        }
        .submenu-item.active {
            background: rgba(76,175,80,0.3);
            border: 2px solid #4CAF50;
        }
        
        /* MODAL */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(10px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 20px;
        }
        .modal {
            background: rgba(0,0,0,0.95);
            backdrop-filter: blur(25px);
            border: 2px solid var(--glass-border);
            border-radius: 20px;
            padding: 25px;
            width: 100%;
            max-width: 400px;
            max-height: 85vh;
            overflow-y: auto;
            color: white;
        }
        .modal h3 {
            margin-bottom: 20px;
            text-align: center;
            font-size: 22px;
        }
        
        /* INPUTS */
        input, textarea, select {
            width: 100%;
            padding: 14px;
            margin: 8px 0;
            background: rgba(255,255,255,0.1);
            border: 2px solid var(--glass-border);
            border-radius: 10px;
            color: white;
            font-size: 16px;
            font-family: inherit;
        }
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #4CAF50;
            background: rgba(255,255,255,0.15);
        }
        input::placeholder, textarea::placeholder {
            color: rgba(255,255,255,0.6);
        }
        select option {
            background: #333;
            color: white;
        }
        
        /* EMOJI GRID */
        .emoji-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }
        .emoji-option {
            width: 100%;
            aspect-ratio: 1;
            border-radius: 12px;
            background: var(--glass-bg);
            border: 2px solid var(--glass-border);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            min-height: 60px;
            cursor: pointer;
        }
        .emoji-option:active {
            background: rgba(255,255,255,0.2);
            transform: scale(0.95);
        }
        
        /* COLOR OPTIONS */
        .color-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 15px;
        }
        .color-option {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 16px;
            background: rgba(255,255,255,0.05);
            border: 2px solid var(--glass-border);
            border-radius: 10px;
            min-height: 60px;
            cursor: pointer;
        }
        .color-option:active {
            background: rgba(255,255,255,0.15);
        }
        .color-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid rgba(255,255,255,0.3);
            flex-shrink: 0;
        }
        .color-label {
            color: white;
            font-weight: 600;
            font-size: 14px;
            flex: 1;
        }
        
        /* SCALING BAR */
        .scaling-bar {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin: 20px 0;
        }
        .scaling-btn {
            aspect-ratio: 1;
            padding: 0;
            font-size: 18px;
            border-radius: 10px;
            min-height: 55px;
        }
        .scaling-btn.active {
            background: rgba(76,175,80,0.5);
            border-color: #4CAF50;
            transform: scale(1.05);
        }
        .scaling-labels {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            opacity: 0.7;
            margin-top: 5px;
        }
        
        /* NOTIFICATION */
        .notification {
            position: fixed;
            top: 70px;
            left: 10px;
            right: 10px;
            background: rgba(76,175,80,0.95);
            color: white;
            padding: 16px 20px;
            border-radius: 12px;
            z-index: 3000;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            font-weight: 600;
            font-size: 14px;
            text-align: center;
            animation: slideDown 0.3s ease;
        }
        @keyframes slideDown {
            from { transform: translateY(-100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        /* REFLEXION */
        .reflexion-item {
            background: rgba(255,255,255,0.05);
            border-left: 4px solid #4CAF50;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 12px;
        }
        .reflexion-category {
            font-size: 12px;
            font-weight: 600;
            opacity: 0.8;
            margin-bottom: 5px;
        }
        .reflexion-question {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
            line-height: 1.4;
        }
        .reflexion-answer {
            font-size: 13px;
            font-style: italic;
            opacity: 0.9;
            margin-bottom: 8px;
            line-height: 1.4;
        }
        .reflexion-timestamp {
            font-size: 11px;
            opacity: 0.6;
        }
        
        /* QUESTION TEXT */
        .question-text {
            background: rgba(255,255,255,0.05);
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
            margin-bottom: 15px;
            line-height: 1.6;
            font-size: 15px;
        }
        
        .mb-10 { margin-bottom: 10px; }
        .hidden { display: none !important; }
        
        /* SAVE INDICATOR */
        .save-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(76,175,80,0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }
        .save-indicator.show {
            opacity: 1;
        }
    </style>
</head>
<body>
    <!-- HEADER -->
    <div class="header">
        <h1>üéØ Reflexions-Radar</h1>
        <div class="header-stats">
            <div class="stat">üë• <span id="memberCount">0</span></div>
            <div class="stat">üîó <span id="connectionCount">0</span></div>
        </div>
    </div>
    
    <!-- POSITION MODE BANNER -->
    <div class="position-mode-banner" id="positionBanner">
        <span>üìç Tippe auf Canvas, um Person zu platzieren</span>
        <button class="cancel-position-btn" id="cancelPositionBtn">Abbrechen</button>
    </div>
    
    <!-- CANVAS -->
    <div id="canvas">
        <div id="canvasContent">
            <svg id="connectionsSvg"></svg>
        </div>
    </div>
    
    <!-- BOTTOM TOOLBAR -->
    <div class="bottom-toolbar">
        <div class="tool-btn" id="btnAddMember">
            <div>‚ûï</div>
            <div class="tool-label">Person</div>
        </div>
        <div class="tool-btn" id="btnAddConnection">
            <div>üîó</div>
            <div class="tool-label">Verbindung</div>
        </div>
        <div class="tool-btn" id="btnReflexion">
            <div>üí≠</div>
            <div class="tool-label">Reflexion</div>
        </div>
        <div class="tool-btn" id="btnMenu">
            <div>‚ò∞</div>
            <div class="tool-label">Men√º</div>
        </div>
    </div>
    
    <!-- MAIN MENU DRAWER -->
    <div class="drawer-overlay" id="drawerOverlay"></div>
    <div class="drawer" id="menuDrawer">
        <div class="drawer-handle"></div>
        <h3>üìã Men√º</h3>
        <button class="btn" id="btnUndo" disabled>‚Ü∂ R√ºckg√§ngig</button>
        <button class="btn" id="btnRedo" disabled>‚Ü∑ Wiederholen</button>
        <button class="btn" id="btnShowReflexions">üìù Reflexions-Historie</button>
        <button class="btn" id="btnShowStats">üìà Statistiken</button>
        <button class="btn" id="btnReset">üîÑ Reset</button>
        <button class="btn" id="btnCloseMenu">‚úï Schlie√üen</button>
    </div>
    
    <!-- STATS DRAWER -->
    <div class="drawer" id="statsDrawer">
        <div class="drawer-handle"></div>
        <h3>üìà Statistiken</h3>
        <div style="background: rgba(255,255,255,0.05); padding: 20px; border-radius: 15px; margin-bottom: 15px;">
            <div style="font-size: 48px; text-align: center; margin-bottom: 10px;" id="avgStressDisplay">0.0</div>
            <div style="text-align: center; opacity: 0.7; margin-bottom: 20px;">‚ö° Durchschnittlicher Stress</div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px;">
                <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 10px; text-align: center;">
                    <div style="font-size: 32px; color: #4CAF50;" id="statMembers">0</div>
                    <div style="font-size: 12px; opacity: 0.7; margin-top: 5px;">üë• Personen</div>
                </div>
                <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 10px; text-align: center;">
                    <div style="font-size: 32px; color: #2196F3;" id="statConnections">0</div>
                    <div style="font-size: 12px; opacity: 0.7; margin-top: 5px;">üîó Verbindungen</div>
                </div>
                <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 10px; text-align: center;">
                    <div style="font-size: 32px; color: #FF9800;" id="statReflexions">0</div>
                    <div style="font-size: 12px; opacity: 0.7; margin-top: 5px;">üí≠ Reflexionen</div>
                </div>
                <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 10px; text-align: center;">
                    <div style="font-size: 32px; color: #9C27B0;" id="statSnapshots">0</div>
                    <div style="font-size: 12px; opacity: 0.7; margin-top: 5px;">üì∑ Snapshots</div>
                </div>
            </div>
        </div>
        <button class="btn" id="btnCloseStats">‚úï Schlie√üen</button>
    </div>
    
    <!-- REFLEXIONS DRAWER -->
    <div class="drawer" id="reflexionsDrawer">
        <div class="drawer-handle"></div>
        <h3>üí≠ Reflexions-Historie</h3>
        <div id="reflexionsList">
            <p style="text-align: center; opacity: 0.7; padding: 40px 20px;">Noch keine Reflexionen</p>
        </div>
        <button class="btn" id="btnCloseReflexions">‚úï Schlie√üen</button>
    </div>
    
    <!-- CONTEXT MENUS -->
    <div class="context-menu" id="memberContextMenu">
        <div class="context-item" data-action="changePosition">
            <div class="context-item-label">
                <span>üìç</span>
                <span>Position √§ndern</span>
            </div>
        </div>
        <div class="context-item" id="stressMenuItem">
            <div class="context-item-label">
                <span>‚ö°</span>
                <span>Stress-Level</span>
            </div>
            <div class="context-item-value" id="stressMenuValue">3/5 ‚ûú</div>
        </div>
        <div class="context-submenu" id="stressSubmenu">
            <div class="submenu-item" data-stress="0">üòå 0 - Entspannt</div>
            <div class="submenu-item" data-stress="1">üôÇ 1 - Sehr ruhig</div>
            <div class="submenu-item" data-stress="2">üòê 2 - Ruhig</div>
            <div class="submenu-item" data-stress="3">üòï 3 - Mittel</div>
            <div class="submenu-item" data-stress="4">üòü 4 - Angespannt</div>
            <div class="submenu-item" data-stress="5">üò∞ 5 - Sehr gestresst</div>
        </div>
        <div class="context-item" data-action="renameMember">
            <div class="context-item-label">
                <span>‚úèÔ∏è</span>
                <span>Umbenennen</span>
            </div>
        </div>
        <div class="context-item" data-action="markAsSelf">
            <div class="context-item-label">
                <span>‚≠ê</span>
                <span>Als mich markieren</span>
            </div>
        </div>
        <div class="context-item" data-action="editNotes">
            <div class="context-item-label">
                <span>üìù</span>
                <span>Notizen bearbeiten</span>
            </div>
        </div>
        <div class="context-item" data-action="addConnection">
            <div class="context-item-label">
                <span>üîó</span>
                <span>Verbindung erstellen</span>
            </div>
        </div>
        <div class="context-item" data-action="deleteMember">
            <div class="context-item-label">
                <span>üóëÔ∏è</span>
                <span>L√∂schen</span>
            </div>
        </div>
    </div>
    
    <div class="context-menu" id="connectionContextMenu">
        <div class="context-item" data-action="changeEmoji">
            <div class="context-item-label">
                <span>üòÄ</span>
                <span>Emoji √§ndern</span>
            </div>
        </div>
        <div class="context-item" data-action="changeColor">
            <div class="context-item-label">
                <span>üé®</span>
                <span>Farbe √§ndern</span>
            </div>
        </div>
        <div class="context-item" data-action="deleteConnection">
            <div class="context-item-label">
                <span>üóëÔ∏è</span>
                <span>L√∂schen</span>
            </div>
        </div>
    </div>
    
    <!-- MODALS -->
    <div class="modal-overlay" id="reflexionModal">
        <div class="modal" style="position: relative;">
            <div class="save-indicator" id="saveIndicator">‚úì Gespeichert</div>
            <h3 id="reflexionTitle">üí≠ Systemische Reflexion</h3>
            <div id="reflexionCategory" class="mb-10" style="text-align: center; font-size: 14px; opacity: 0.8;"></div>
            <div id="reflexionQuestion" class="question-text"></div>
            <div id="reflexionInput"></div>
            <button class="btn" id="btnNextReflexion">‚û°Ô∏è N√§chste Frage</button>
            <button class="btn" id="btnOtherCategory">üîÄ Andere Kategorie</button>
            <button class="btn" id="btnCloseReflexionModal">‚úì Fertig</button>
        </div>
    </div>
    
    <div class="modal-overlay" id="simpleInputModal">
        <div class="modal">
            <h3 id="simpleInputTitle">Eingabe</h3>
            <input type="text" id="simpleInputField" placeholder="">
            <textarea id="simpleTextareaField" rows="4" placeholder="" style="display:none;"></textarea>
            <button class="btn" id="btnSimpleInputOK">‚úì OK</button>
            <button class="btn" id="btnSimpleInputCancel">‚úï Abbrechen</button>
        </div>
    </div>
    
    <div class="modal-overlay" id="connectionModal">
        <div class="modal">
            <h3>üîó Verbindung erstellen</h3>
            <p style="margin-bottom: 15px; text-align: center;">W√§hle zwei Personen:</p>
            <select id="connectionFrom"><option value="">-- Von Person --</option></select>
            <select id="connectionTo"><option value="">-- Zu Person --</option></select>
            <button class="btn" id="btnCreateConnection">üîó Erstellen</button>
            <button class="btn" id="btnCancelConnection">‚úï Abbrechen</button>
        </div>
    </div>
    
    <div class="modal-overlay" id="emojiModal">
        <div class="modal">
            <h3>üòÄ Emoji w√§hlen</h3>
            <div style="max-height: 50vh; overflow-y: auto;">
                <div style="margin-bottom: 20px;">
                    <div style="color: #667eea; font-size: 14px; font-weight: 600; margin-bottom: 10px;">ü§ù Zusammenarbeit</div>
                    <div class="emoji-grid">
                        <div class="emoji-option" data-emoji="ü§ù">ü§ù</div>
                        <div class="emoji-option" data-emoji="üëè">üëè</div>
                        <div class="emoji-option" data-emoji="üôå">üôå</div>
                        <div class="emoji-option" data-emoji="üëç">üëç</div>
                    </div>
                </div>
                <div style="margin-bottom: 20px;">
                    <div style="color: #667eea; font-size: 14px; font-weight: 600; margin-bottom: 10px;">üí¨ Kommunikation</div>
                    <div class="emoji-grid">
                        <div class="emoji-option" data-emoji="üí¨">üí¨</div>
                        <div class="emoji-option" data-emoji="üìû">üìû</div>
                        <div class="emoji-option" data-emoji="üó£Ô∏è">üó£Ô∏è</div>
                        <div class="emoji-option" data-emoji="üí≠">üí≠</div>
                    </div>
                </div>
                <div style="margin-bottom: 20px;">
                    <div style="color: #667eea; font-size: 14px; font-weight: 600; margin-bottom: 10px;">‚ù§Ô∏è Beziehung</div>
                    <div class="emoji-grid">
                        <div class="emoji-option" data-emoji="‚ù§Ô∏è">‚ù§Ô∏è</div>
                        <div class="emoji-option" data-emoji="üíô">üíô</div>
                        <div class="emoji-option" data-emoji="üíö">üíö</div>
                        <div class="emoji-option" data-emoji="üíú">üíú</div>
                    </div>
                </div>
                <div style="margin-bottom: 20px;">
                    <div style="color: #667eea; font-size: 14px; font-weight: 600; margin-bottom: 10px;">‚ö° Energie</div>
                    <div class="emoji-grid">
                        <div class="emoji-option" data-emoji="‚ö°">‚ö°</div>
                        <div class="emoji-option" data-emoji="üî•">üî•</div>
                        <div class="emoji-option" data-emoji="‚ú®">‚ú®</div>
                        <div class="emoji-option" data-emoji="üåü">üåü</div>
                    </div>
                </div>
                <div style="margin-bottom: 20px;">
                    <div style="color: #667eea; font-size: 14px; font-weight: 600; margin-bottom: 10px;">‚ö†Ô∏è Konflikt</div>
                    <div class="emoji-grid">
                        <div class="emoji-option" data-emoji="üíî">üíî</div>
                        <div class="emoji-option" data-emoji="‚ö†Ô∏è">‚ö†Ô∏è</div>
                        <div class="emoji-option" data-emoji="üí•">üí•</div>
                        <div class="emoji-option" data-emoji="üò°">üò°</div>
                    </div>
                </div>
            </div>
            <button class="btn" id="btnCloseEmoji">‚úï Schlie√üen</button>
        </div>
    </div>
    
    <div class="modal-overlay" id="colorModal">
        <div class="modal">
            <h3>üé® Farbe w√§hlen</h3>
            <div class="color-options">
                <div class="color-option" data-color="#4CAF50">
                    <div class="color-circle" style="background: #4CAF50;"></div>
                    <div class="color-label">üü¢ Gr√ºn - Harmonie</div>
                </div>
                <div class="color-option" data-color="#2196F3">
                    <div class="color-circle" style="background: #2196F3;"></div>
                    <div class="color-label">üîµ Blau - Neutral</div>
                </div>
                <div class="color-option" data-color="#FF9800">
                    <div class="color-circle" style="background: #FF9800;"></div>
                    <div class="color-label">üü† Orange - Energie</div>
                </div>
                <div class="color-option" data-color="#F44336">
                    <div class="color-circle" style="background: #F44336;"></div>
                    <div class="color-label">üî¥ Rot - Konflikt</div>
                </div>
                <div class="color-option" data-color="#9C27B0">
                    <div class="color-circle" style="background: #9C27B0;"></div>
                    <div class="color-label">üü£ Lila - Kreativ</div>
                </div>
                <div class="color-option" data-color="#9E9E9E">
                    <div class="color-circle" style="background: #9E9E9E;"></div>
                    <div class="color-label">‚ö´ Grau - Distanz</div>
                </div>
            </div>
            <button class="btn" id="btnCloseColor">‚úï Schlie√üen</button>
        </div>
    </div>

    <script>
const APP_VERSION="5.4.9-M-FIXED";

// Core State
let members=[],connections=[],snapshots=[],reflexionAnswers=[],sessions=[],history=[],historyIndex=-1;
let nextId=1,nextConnectionId=1,personCounter=1,currentSnapshotIndex=0;
let selectedMember=null,selectedConnection=null;
let draggedMember=null;
let currentReflexionCategory=null,currentReflexionIndex=0,currentQuestionType=null,currentScalingValue=5;

// Position Mode State
let positionMode=false;
let memberBeingPositioned=null;

// Touch/Pan State
let panOffset={x:0,y:0};
let touchStartPos=null;
let initialTouches=null;
let isTwoFingerPan=false;
let isDragging=false;

// Auto-Save State
let autoSaveTimer=null;
let currentReflexionDraft=null;

const REFLEXIONS_SYSTEM={
    selbstreflexion:{
        name:"ü™û Selbstreflexion",
        color:"#E91E63",
        questions:["Welche Rolle nehme ich im Team ein?","Was hindert mich daran, meine Position zu ver√§ndern?","Wo sp√ºre ich Widerstand in mir?"]
    },
    beziehungsdynamik:{
        name:"üîó Beziehungsdynamik",
        color:"#2196F3",
        questions:["Zu wem habe ich die schw√§chste Verbindung?","Welche Beziehung kostet mich Energie?","Wo entstehen wiederkehrende Muster?"]
    },
    entwicklung:{
        name:"üìà Entwicklung",
        color:"#4CAF50",
        questions:["Was hat sich in den letzten Monaten ver√§ndert?","Welche Entwicklung √ºberrascht mich?","Wo sehe ich Potentiale f√ºr Wachstum?"]
    },
    systemisch:{
        name:"üîÑ Systemisch",
        color:"#FF9800",
        questions:["Was w√ºrde X √ºber Y sagen?","Welches Problem l√∂st meine Position?","Was w√ºrde fehlen, wenn ich nicht da w√§re?"]
    },
    vision:{
        name:"‚ú® Vision",
        color:"#9C27B0",
        questions:["Wie s√§he unser ideales Team aus?","Was ist mein gr√∂√üter Wunsch f√ºr uns?","Woran w√ºrden wir merken, dass es besser ist?"]
    }
};

const SCALING_QUESTIONS=[
    "Auf einer Skala von 1-10: Wie zufrieden bist du mit deiner Position im Team?",
    "Wie stark f√ºhlst du dich vom Team unterst√ºtzt? (1-10)",
    "Wie klar sind dir deine Aufgaben im Team? (1-10)"
];

const MIRACLE_QUESTIONS=[
    "Angenommen, √ºber Nacht gesch√§he ein Wunder und unser Team w√§re perfekt - woran w√ºrden wir das morgen fr√ºh merken?",
    "Wenn alle Hindernisse verschw√§nden - wie w√ºrden wir dann zusammenarbeiten?"
];

function init(){
    loadFromLocalStorage();
    if(snapshots.length===0){
        snapshots.push({id:Date.now(),name:"Ausgangssituation",timestamp:new Date().toLocaleString('de-DE'),members:[],connections:[]});
    }
    setupEventListeners();
    applyPan();
    render();
}

function setupEventListeners(){
    // Toolbar
    document.getElementById('btnAddMember').addEventListener('click',addMember);
    document.getElementById('btnAddConnection').addEventListener('click',()=>startConnectionCreation(null));
    document.getElementById('btnReflexion').addEventListener('click',showReflexionModal);
    document.getElementById('btnMenu').addEventListener('click',()=>openDrawer('menuDrawer'));
    
    // Position mode
    document.getElementById('cancelPositionBtn').addEventListener('click',cancelPositionMode);
    
    // Menu drawer
    document.getElementById('btnUndo').addEventListener('click',undo);
    document.getElementById('btnRedo').addEventListener('click',redo);
    document.getElementById('btnShowReflexions').addEventListener('click',()=>{closeAllDrawers();openDrawer('reflexionsDrawer');updateReflexionsList();});
    document.getElementById('btnShowStats').addEventListener('click',()=>{closeAllDrawers();openDrawer('statsDrawer');updateStats();});
    document.getElementById('btnReset').addEventListener('click',resetApp);
    document.getElementById('btnCloseMenu').addEventListener('click',closeAllDrawers);
    document.getElementById('btnCloseReflexions').addEventListener('click',closeAllDrawers);
    document.getElementById('btnCloseStats').addEventListener('click',closeAllDrawers);
    
    // Overlay - NUR bei direktem Tap auf Overlay, NICHT bei Drawer-Content
    document.getElementById('drawerOverlay').addEventListener('click',(e)=>{
        if(e.target.id==='drawerOverlay'){
            closeAllDrawers();
        }
    });
    
    // Verhindere dass Drawer-Touches zum Overlay propagieren
    document.querySelectorAll('.drawer').forEach(drawer=>{
        drawer.addEventListener('touchstart',(e)=>{
            e.stopPropagation();
        });
        drawer.addEventListener('click',(e)=>{
            e.stopPropagation();
        });
    });
    
    // Canvas touch
    const canvas=document.getElementById('canvas');
    canvas.addEventListener('touchstart',onTouchStart,{passive:false});
    canvas.addEventListener('touchmove',onTouchMove,{passive:false});
    canvas.addEventListener('touchend',onTouchEnd,{passive:false});
    canvas.addEventListener('touchcancel',onTouchEnd,{passive:false});
    
    // Global click to hide context menus
    document.addEventListener('click',(e)=>{
        if(!e.target.closest('.context-menu')){
            hideAllContextMenus();
        }
    });
    
    // Member context menu
    document.querySelectorAll('#memberContextMenu .context-item').forEach(el=>{
        el.addEventListener('click',function(){
            const action=this.getAttribute('data-action');
            if(!action)return; // For stress menu item
            hideAllContextMenus();
            if(!selectedMember)return;
            if(action==='changePosition')startPositionMode(selectedMember);
            else if(action==='renameMember')renameMember(selectedMember);
            else if(action==='markAsSelf')markAsSelf(selectedMember);
            else if(action==='editNotes')editNotes(selectedMember);
            else if(action==='addConnection')startConnectionCreation(selectedMember);
            else if(action==='deleteMember')deleteMember(selectedMember);
        });
    });
    
    // Stress menu item toggle
    document.getElementById('stressMenuItem').addEventListener('click',function(e){
        e.stopPropagation();
        const submenu=document.getElementById('stressSubmenu');
        submenu.classList.toggle('open');
    });
    
    // Stress submenu items
    document.querySelectorAll('#stressSubmenu .submenu-item').forEach(el=>{
        el.addEventListener('click',function(e){
            e.stopPropagation();
            const stress=parseInt(this.getAttribute('data-stress'));
            if(selectedMember){
                selectedMember.stress=stress;
                render();
                saveState();
                saveToLocalStorage();
                showNotification('‚ö° Stress ge√§ndert: '+stress+'/5');
                hideAllContextMenus();
            }
        });
    });
    
    // Connection context menu
    document.querySelectorAll('#connectionContextMenu .context-item').forEach(el=>{
        el.addEventListener('click',function(){
            const action=this.getAttribute('data-action');
            hideAllContextMenus();
            if(!selectedConnection)return;
            if(action==='changeEmoji')showEmojiModal();
            else if(action==='changeColor')showColorModal();
            else if(action==='deleteConnection')deleteConnection(selectedConnection);
        });
    });
    
    // Emoji/Color
    document.querySelectorAll('.emoji-option').forEach(el=>{
        el.addEventListener('click',function(){
            const emoji=this.getAttribute('data-emoji');
            if(selectedConnection){
                selectedConnection.emoji=emoji;
                render();
                saveState();
                saveToLocalStorage();
            }
            closeModal('emojiModal');
            showNotification('üòÄ Emoji ge√§ndert');
        });
    });
    document.getElementById('btnCloseEmoji').addEventListener('click',()=>closeModal('emojiModal'));
    
    document.querySelectorAll('.color-option').forEach(el=>{
        el.addEventListener('click',function(){
            const color=this.getAttribute('data-color');
            if(selectedConnection){
                selectedConnection.color=color;
                render();
                saveState();
                saveToLocalStorage();
            }
            closeModal('colorModal');
            showNotification('üé® Farbe ge√§ndert');
        });
    });
    document.getElementById('btnCloseColor').addEventListener('click',()=>closeModal('colorModal'));
    
    // Reflexion
    document.getElementById('btnNextReflexion').addEventListener('click',nextReflexion);
    document.getElementById('btnOtherCategory').addEventListener('click',otherCategory);
    document.getElementById('btnCloseReflexionModal').addEventListener('click',()=>{
        autoSaveCurrentReflexion();
        closeModal('reflexionModal');
    });
    
    // Connection modal
    document.getElementById('btnCreateConnection').addEventListener('click',createConnection);
    document.getElementById('btnCancelConnection').addEventListener('click',()=>closeModal('connectionModal'));
    
    // Simple input
    document.getElementById('btnSimpleInputOK').addEventListener('click',function(){
        if(window.simpleInputCallback){
            const val=document.getElementById('simpleTextareaField').style.display!=='none'?
                document.getElementById('simpleTextareaField').value:
                document.getElementById('simpleInputField').value;
            window.simpleInputCallback(val);
        }
        closeModal('simpleInputModal');
    });
    document.getElementById('btnSimpleInputCancel').addEventListener('click',()=>closeModal('simpleInputModal'));
}

// ========== POSITION MODE ==========

function startPositionMode(member){
    positionMode=true;
    memberBeingPositioned=member;
    document.getElementById('positionBanner').classList.add('active');
    document.getElementById('canvas').classList.add('position-mode');
    render();
    showNotification('üìç Tippe auf Canvas, um '+member.name+' zu platzieren');
}

function cancelPositionMode(){
    positionMode=false;
    memberBeingPositioned=null;
    document.getElementById('positionBanner').classList.remove('active');
    document.getElementById('canvas').classList.remove('position-mode');
    render();
}

// ========== TOUCH HANDLING ==========

function onTouchStart(e){
    if(e.touches.length===2){
        // Two-finger pan
        e.preventDefault();
        isTwoFingerPan=true;
        isDragging=false;
        const touch1=e.touches[0];
        const touch2=e.touches[1];
        initialTouches={
            x:(touch1.clientX+touch2.clientX)/2,
            y:(touch1.clientY+touch2.clientY)/2
        };
    }else if(e.touches.length===1){
        const touch=e.touches[0];
        const target=e.target;
        
        // Position mode - tap to place
        if(positionMode && !target.closest('.member') && !target.closest('.connection-emoji')){
            e.preventDefault();
            const canvasRect=document.getElementById('canvas').getBoundingClientRect();
            const x=touch.clientX-canvasRect.left-panOffset.x-55;
            const y=touch.clientY-canvasRect.top-panOffset.y-55;
            
            if(memberBeingPositioned){
                memberBeingPositioned.x=Math.max(0,Math.min(x,canvasRect.width-110));
                memberBeingPositioned.y=Math.max(0,Math.min(y,canvasRect.height-110));
                saveState();
                saveToLocalStorage();
                showNotification('‚úÖ Position gesetzt');
                cancelPositionMode();
            }
            return;
        }
        
        // Check if tapping member menu button
        if(target.classList.contains('member-menu-btn')){
            e.preventDefault();
            const memberId=parseInt(target.closest('.member').getAttribute('data-id'));
            selectedMember=members.find(m=>m.id===memberId);
            updateStressMenuDisplay();
            showMemberContextMenu();
            return;
        }
        
        // Check if tapping connection emoji
        if(target.classList.contains('connection-emoji')){
            e.preventDefault();
            const connId=parseInt(target.getAttribute('data-conn-id'));
            selectedConnection=connections.find(c=>c.id===connId);
            if(selectedConnection)showConnectionContextMenu();
            return;
        }
        
        // Check if tapping member (for drag)
        const memberEl=target.closest('.member');
        if(memberEl && !positionMode){
            e.preventDefault();
            const memberId=parseInt(memberEl.getAttribute('data-id'));
            draggedMember=members.find(m=>m.id===memberId);
            if(draggedMember){
                const canvasRect=document.getElementById('canvas').getBoundingClientRect();
                touchStartPos={
                    x:touch.clientX-canvasRect.left-panOffset.x-draggedMember.x,
                    y:touch.clientY-canvasRect.top-panOffset.y-draggedMember.y
                };
                memberEl.classList.add('dragging');
                isDragging=true;
            }
            return;
        }
    }
}

function onTouchMove(e){
    e.preventDefault();
    
    if(e.touches.length===2 && isTwoFingerPan){
        const touch1=e.touches[0];
        const touch2=e.touches[1];
        const midX=(touch1.clientX+touch2.clientX)/2;
        const midY=(touch1.clientY+touch2.clientY)/2;
        
        if(initialTouches){
            const dx=midX-initialTouches.x;
            const dy=midY-initialTouches.y;
            panOffset.x+=dx;
            panOffset.y+=dy;
            applyPan();
            initialTouches={x:midX,y:midY};
        }
    }else if(e.touches.length===1 && draggedMember && isDragging){
        const touch=e.touches[0];
        const canvas=document.getElementById('canvas');
        const canvasRect=canvas.getBoundingClientRect();
        
        let newX=touch.clientX-canvasRect.left-panOffset.x-touchStartPos.x;
        let newY=touch.clientY-canvasRect.top-panOffset.y-touchStartPos.y;
        
        const maxX=canvasRect.width-110;
        const maxY=canvasRect.height-110;
        
        newX=Math.max(0,Math.min(newX,maxX));
        newY=Math.max(0,Math.min(newY,maxY));
        
        draggedMember.x=newX;
        draggedMember.y=newY;
        render();
    }
}

function onTouchEnd(e){
    if(draggedMember && isDragging){
        const memberEl=document.querySelector(`.member[data-id="${draggedMember.id}"]`);
        if(memberEl)memberEl.classList.remove('dragging');
        saveState();
        saveToLocalStorage();
        draggedMember=null;
    }
    
    isTwoFingerPan=false;
    isDragging=false;
    touchStartPos=null;
    initialTouches=null;
}

// ========== PAN ==========

function applyPan(){
    const content=document.getElementById('canvasContent');
    content.style.transform=`translate(${panOffset.x}px, ${panOffset.y}px)`;
    saveToLocalStorage();
}

// ========== RENDER ==========

function render(){
    const canvas=document.getElementById('canvasContent');
    const svg=document.getElementById('connectionsSvg');
    
    Array.from(canvas.children).forEach(child=>{
        if(child.id!=='connectionsSvg')child.remove();
    });
    
    svg.innerHTML='';
    
    // Render connections
    connections.forEach(conn=>{
        const fromMember=members.find(m=>m.id===conn.from);
        const toMember=members.find(m=>m.id===conn.to);
        
        if(fromMember && toMember){
            const line=document.createElementNS("http://www.w3.org/2000/svg","line");
            line.setAttribute('x1',fromMember.x+55);
            line.setAttribute('y1',fromMember.y+55);
            line.setAttribute('x2',toMember.x+55);
            line.setAttribute('y2',toMember.y+55);
            line.setAttribute('stroke',conn.color);
            svg.appendChild(line);
            
            const midX=(fromMember.x+toMember.x)/2+55;
            const midY=(fromMember.y+toMember.y)/2+55;
            
            const emojiDiv=document.createElement('div');
            emojiDiv.className='connection-emoji';
            emojiDiv.style.left=midX+'px';
            emojiDiv.style.top=midY+'px';
            emojiDiv.textContent=conn.emoji;
            emojiDiv.setAttribute('data-conn-id',conn.id);
            canvas.appendChild(emojiDiv);
        }
    });
    
    // Render members
    members.forEach(member=>{
        const div=document.createElement('div');
        div.className='member stress-'+member.stress;
        if(member.isSelf)div.classList.add('self');
        if(memberBeingPositioned && memberBeingPositioned.id===member.id){
            div.classList.add('being-positioned');
        }
        div.style.left=member.x+'px';
        div.style.top=member.y+'px';
        div.setAttribute('data-id',member.id);
        
        const nameDiv=document.createElement('div');
        nameDiv.className='member-name';
        nameDiv.textContent=member.name+(member.isSelf?' ‚≠ê':'');
        
        const stressDiv=document.createElement('div');
        stressDiv.className='stress-indicator';
        stressDiv.textContent=getStressEmoji(member.stress)+' '+member.stress+'/5';
        
        const menuBtn=document.createElement('div');
        menuBtn.className='member-menu-btn';
        menuBtn.textContent='‚ãÆ';
        
        div.appendChild(menuBtn);
        div.appendChild(nameDiv);
        div.appendChild(stressDiv);
        
        if(member.notes && member.notes.trim()){
            const notesBadge=document.createElement('div');
            notesBadge.className='notes-badge';
            notesBadge.textContent='üìù';
            div.appendChild(notesBadge);
        }
        
        canvas.appendChild(div);
    });
    
    updateStats();
    updateUndoRedoButtons();
}

function getStressEmoji(stress){
    return ['‚ö™','üòå','üôÇ','üòê','üòü','üò∞'][stress]||'‚ö™';
}

function updateStats(){
    document.getElementById('memberCount').textContent=members.length;
    document.getElementById('connectionCount').textContent=connections.length;
    document.getElementById('statMembers').textContent=members.length;
    document.getElementById('statConnections').textContent=connections.length;
    document.getElementById('statReflexions').textContent=reflexionAnswers.length;
    document.getElementById('statSnapshots').textContent=snapshots.length;
    
    const membersWithStress=members.filter(m=>m.stress>0);
    if(membersWithStress.length>0){
        const avgStress=membersWithStress.reduce((sum,m)=>sum+m.stress,0)/membersWithStress.length;
        document.getElementById('avgStressDisplay').textContent=avgStress.toFixed(1);
    }else{
        document.getElementById('avgStressDisplay').textContent='0.0';
    }
}

function updateStressMenuDisplay(){
    if(selectedMember){
        document.getElementById('stressMenuValue').textContent=selectedMember.stress+'/5 ‚ûú';
        document.querySelectorAll('#stressSubmenu .submenu-item').forEach((el,i)=>{
            if(i===selectedMember.stress){
                el.classList.add('active');
            }else{
                el.classList.remove('active');
            }
        });
    }
}

// ========== UNDO/REDO ==========

function saveState(){
    history=history.slice(0,historyIndex+1);
    history.push({
        members:JSON.parse(JSON.stringify(members)),
        connections:JSON.parse(JSON.stringify(connections))
    });
    if(history.length>50){
        history.shift();
    }else{
        historyIndex++;
    }
    updateUndoRedoButtons();
}

function undo(){
    if(historyIndex>0){
        historyIndex--;
        const state=history[historyIndex];
        members=JSON.parse(JSON.stringify(state.members));
        connections=JSON.parse(JSON.stringify(state.connections));
        render();
        saveToLocalStorage();
    }
}

function redo(){
    if(historyIndex<history.length-1){
        historyIndex++;
        const state=history[historyIndex];
        members=JSON.parse(JSON.stringify(state.members));
        connections=JSON.parse(JSON.stringify(state.connections));
        render();
        saveToLocalStorage();
    }
}

function updateUndoRedoButtons(){
    document.getElementById('btnUndo').disabled=historyIndex<=0;
    document.getElementById('btnRedo').disabled=historyIndex>=history.length-1;
}

// ========== MEMBERS ==========

function addMember(){
    showSimpleInput("Person hinzuf√ºgen","Name (optional):",false,(name)=>{
        if(!name || !name.trim()){
            name='Person '+personCounter;
            personCounter++;
        }
        members.push({
            id:nextId++,
            name:name,
            x:150,
            y:150,
            stress:3,
            notes:'',
            isSelf:false
        });
        render();
        saveState();
        saveToLocalStorage();
        showNotification('‚úÖ Person hinzugef√ºgt: '+name);
    });
}

function renameMember(member){
    showSimpleInput("Umbenennen","Neuer Name:",false,(name)=>{
        if(name){
            member.name=name;
            render();
            saveState();
            saveToLocalStorage();
            showNotification('‚úèÔ∏è Umbenannt');
        }
    });
}

function markAsSelf(member){
    members.forEach(m=>m.isSelf=false);
    member.isSelf=true;
    render();
    saveState();
    saveToLocalStorage();
    showNotification('‚≠ê Als "Ich" markiert: '+member.name);
}

function editNotes(member){
    document.getElementById('simpleTextareaField').value=member.notes||'';
    showSimpleInput("Notizen bearbeiten","Notizen f√ºr "+member.name+":",true,(notes)=>{
        member.notes=notes;
        render();
        saveState();
        saveToLocalStorage();
        showNotification('üìù Notizen gespeichert');
    });
}

function deleteMember(member){
    if(confirm('Person "'+member.name+'" l√∂schen?')){
        connections=connections.filter(c=>c.from!==member.id && c.to!==member.id);
        members=members.filter(m=>m.id!==member.id);
        render();
        saveState();
        saveToLocalStorage();
        showNotification('üóëÔ∏è Person gel√∂scht');
    }
}

// ========== CONNECTIONS ==========

function startConnectionCreation(fromMember){
    const modal=document.getElementById('connectionModal');
    const fromSelect=document.getElementById('connectionFrom');
    const toSelect=document.getElementById('connectionTo');
    
    fromSelect.innerHTML='<option value="">-- Von Person --</option>';
    toSelect.innerHTML='<option value="">-- Zu Person --</option>';
    
    members.forEach(m=>{
        const opt1=document.createElement('option');
        opt1.value=m.id;
        opt1.textContent=m.name;
        fromSelect.appendChild(opt1);
        
        const opt2=document.createElement('option');
        opt2.value=m.id;
        opt2.textContent=m.name;
        toSelect.appendChild(opt2);
    });
    
    if(fromMember){
        fromSelect.value=fromMember.id;
    }
    
    openModal('connectionModal');
}

function createConnection(){
    const fromId=parseInt(document.getElementById('connectionFrom').value);
    const toId=parseInt(document.getElementById('connectionTo').value);
    
    if(!fromId || !toId){
        showNotification('‚ö†Ô∏è Bitte beide Personen ausw√§hlen');
        return;
    }
    
    if(fromId===toId){
        showNotification('‚ö†Ô∏è Gleiche Person kann nicht verbunden werden');
        return;
    }
    
    if(connections.some(c=>(c.from===fromId && c.to===toId)||(c.from===toId && c.to===fromId))){
        showNotification('‚ö†Ô∏è Verbindung existiert bereits');
        return;
    }
    
    connections.push({
        id:nextConnectionId++,
        from:fromId,
        to:toId,
        emoji:'ü§ù',
        color:'#4CAF50'
    });
    
    closeModal('connectionModal');
    render();
    saveState();
    saveToLocalStorage();
    showNotification('üîó Verbindung erstellt');
}

function deleteConnection(conn){
    if(confirm('Verbindung l√∂schen?')){
        connections=connections.filter(c=>c.id!==conn.id);
        render();
        saveState();
        saveToLocalStorage();
        showNotification('üóëÔ∏è Verbindung gel√∂scht');
    }
}

function showConnectionContextMenu(){
    document.getElementById('connectionContextMenu').style.display='block';
}

function showMemberContextMenu(){
    document.getElementById('memberContextMenu').style.display='block';
}

function showEmojiModal(){
    openModal('emojiModal');
}

function showColorModal(){
    openModal('colorModal');
}

// ========== REFLEXION ==========

function showReflexionModal(){
    const categories=Object.keys(REFLEXIONS_SYSTEM);
    currentReflexionCategory=categories[Math.floor(Math.random()*categories.length)];
    currentReflexionIndex=0;
    
    const rand=Math.random();
    currentQuestionType=rand<0.6?'text':(rand<0.85?'scaling':'miracle');
    
    displayCurrentReflexion();
    openModal('reflexionModal');
}

function displayCurrentReflexion(){
    const catData=REFLEXIONS_SYSTEM[currentReflexionCategory];
    let question;
    
    document.getElementById('reflexionTitle').textContent='üí≠ Systemische Reflexion';
    document.getElementById('reflexionCategory').textContent=catData.name;
    document.getElementById('reflexionCategory').style.color=catData.color;
    
    if(currentQuestionType==='text'){
        question=catData.questions[currentReflexionIndex%catData.questions.length];
        document.getElementById('reflexionQuestion').textContent=question;
        document.getElementById('reflexionInput').innerHTML='<textarea id="reflexionAnswer" rows="4" placeholder="Deine Gedanken..."></textarea>';
        setupTextAutoSave();
    }else if(currentQuestionType==='scaling'){
        question=SCALING_QUESTIONS[Math.floor(Math.random()*SCALING_QUESTIONS.length)];
        document.getElementById('reflexionQuestion').textContent=question;
        let html='<div class="scaling-bar">';
        for(let i=1;i<=3;i++){
            html+=`<button class="btn scaling-btn${i===currentScalingValue?' active':''}" onclick="selectScaling(${i})">${i}</button>`;
        }
        html+='</div><div class="scaling-bar">';
        for(let i=4;i<=6;i++){
            html+=`<button class="btn scaling-btn${i===currentScalingValue?' active':''}" onclick="selectScaling(${i})">${i}</button>`;
        }
        html+='</div><div class="scaling-bar">';
        for(let i=7;i<=9;i++){
            html+=`<button class="btn scaling-btn${i===currentScalingValue?' active':''}" onclick="selectScaling(${i})">${i}</button>`;
        }
        html+='</div><div class="scaling-bar"><button class="btn scaling-btn'+(10===currentScalingValue?' active':'')+'" onclick="selectScaling(10)">10</button><div style="grid-column:span 2;"></div></div>';
        html+='<div class="scaling-labels"><span>niedrig</span><span>hoch</span></div>';
        document.getElementById('reflexionInput').innerHTML=html;
    }else{
        question=MIRACLE_QUESTIONS[Math.floor(Math.random()*MIRACLE_QUESTIONS.length)];
        document.getElementById('reflexionQuestion').textContent=question;
        document.getElementById('reflexionInput').innerHTML='<textarea id="reflexionAnswer" rows="4" placeholder="Was w√ºrde sich √§ndern?"></textarea>';
        setupTextAutoSave();
    }
    
    currentReflexionDraft={
        category:catData.name,
        categoryColor:catData.color,
        question:question,
        type:currentQuestionType
    };
}

function setupTextAutoSave(){
    const textarea=document.getElementById('reflexionAnswer');
    if(textarea){
        textarea.oninput=()=>{
            clearTimeout(autoSaveTimer);
            autoSaveTimer=setTimeout(()=>{
                autoSaveCurrentReflexion();
            },2000);
        };
    }
}

function selectScaling(value){
    currentScalingValue=value;
    document.querySelectorAll('#reflexionInput .scaling-btn').forEach((btn,i)=>{
        const btnVal=parseInt(btn.textContent);
        if(btnVal===value){
            btn.classList.add('active');
        }else{
            btn.classList.remove('active');
        }
    });
    autoSaveCurrentReflexion();
}

function autoSaveCurrentReflexion(){
    if(!currentReflexionDraft)return;
    
    let answer;
    if(currentQuestionType==='scaling'){
        answer=currentScalingValue+'/10';
    }else{
        const textarea=document.getElementById('reflexionAnswer');
        if(!textarea)return;
        answer=textarea.value;
        if(!answer || !answer.trim())return;
    }
    
    const existingIndex=reflexionAnswers.findIndex(r=>
        r.question===currentReflexionDraft.question && r.category===currentReflexionDraft.category
    );
    
    if(existingIndex>=0){
        reflexionAnswers[existingIndex].answer=answer;
        reflexionAnswers[existingIndex].timestamp=new Date().toLocaleString('de-DE');
    }else{
        reflexionAnswers.push({
            category:currentReflexionDraft.category,
            categoryColor:currentReflexionDraft.categoryColor,
            question:currentReflexionDraft.question,
            answer:answer,
            type:currentReflexionDraft.type,
            timestamp:new Date().toLocaleString('de-DE')
        });
    }
    
    saveToLocalStorage();
    updateStats();
    showSaveIndicator();
}

function showSaveIndicator(){
    const indicator=document.getElementById('saveIndicator');
    indicator.classList.add('show');
    setTimeout(()=>{
        indicator.classList.remove('show');
    },2000);
}

function nextReflexion(){
    autoSaveCurrentReflexion();
    currentReflexionIndex++;
    if(currentReflexionIndex>=REFLEXIONS_SYSTEM[currentReflexionCategory].questions.length){
        const categories=Object.keys(REFLEXIONS_SYSTEM);
        const currentIndex=categories.indexOf(currentReflexionCategory);
        currentReflexionCategory=categories[(currentIndex+1)%categories.length];
        currentReflexionIndex=0;
    }
    const rand=Math.random();
    currentQuestionType=rand<0.6?'text':(rand<0.85?'scaling':'miracle');
    currentScalingValue=5;
    displayCurrentReflexion();
}

function otherCategory(){
    autoSaveCurrentReflexion();
    const categories=Object.keys(REFLEXIONS_SYSTEM);
    const otherCategories=categories.filter(c=>c!==currentReflexionCategory);
    currentReflexionCategory=otherCategories[Math.floor(Math.random()*otherCategories.length)];
    currentReflexionIndex=0;
    const rand=Math.random();
    currentQuestionType=rand<0.6?'text':(rand<0.85?'scaling':'miracle');
    currentScalingValue=5;
    displayCurrentReflexion();
}

function updateReflexionsList(){
    const list=document.getElementById('reflexionsList');
    if(reflexionAnswers.length===0){
        list.innerHTML='<p style="text-align: center; opacity: 0.7; padding: 40px 20px;">Noch keine Reflexionen</p>';
        return;
    }
    
    let html='';
    reflexionAnswers.slice().reverse().forEach((r)=>{
        html+=`<div class="reflexion-item" style="border-left-color: ${r.categoryColor};">
            <div class="reflexion-category">${r.category}</div>
            <div class="reflexion-question">${r.question}</div>
            <div class="reflexion-answer">"${r.answer}"</div>
            <div class="reflexion-timestamp">${r.timestamp}</div>
        </div>`;
    });
    list.innerHTML=html;
}

// ========== UI HELPERS ==========

function openDrawer(drawerId){
    document.getElementById('drawerOverlay').style.display='block';
    const drawer=document.getElementById(drawerId);
    drawer.style.display='block';
    setTimeout(()=>{
        drawer.classList.add('open');
    },10);
}

function closeAllDrawers(){
    document.getElementById('drawerOverlay').style.display='none';
    document.querySelectorAll('.drawer').forEach(drawer=>{
        drawer.classList.remove('open');
        setTimeout(()=>{
            drawer.style.display='none';
        },300);
    });
}

function openModal(modalId){
    document.getElementById(modalId).style.display='flex';
}

function closeModal(modalId){
    document.getElementById(modalId).style.display='none';
}

function hideAllContextMenus(){
    document.querySelectorAll('.context-menu').forEach(menu=>{
        menu.style.display='none';
    });
    document.getElementById('stressSubmenu').classList.remove('open');
}

function showSimpleInput(title,placeholder,isTextarea,callback){
    window.simpleInputCallback=callback;
    document.getElementById('simpleInputTitle').textContent=title;
    
    if(isTextarea){
        document.getElementById('simpleInputField').style.display='none';
        document.getElementById('simpleTextareaField').style.display='block';
        document.getElementById('simpleTextareaField').placeholder=placeholder;
        document.getElementById('simpleTextareaField').value='';
    }else{
        document.getElementById('simpleInputField').style.display='block';
        document.getElementById('simpleTextareaField').style.display='none';
        document.getElementById('simpleInputField').placeholder=placeholder;
        document.getElementById('simpleInputField').value='';
    }
    
    openModal('simpleInputModal');
}

function showNotification(message){
    const notif=document.createElement('div');
    notif.className='notification';
    notif.textContent=message;
    document.body.appendChild(notif);
    setTimeout(()=>{
        notif.remove();
    },3000);
}

function resetApp(){
    if(confirm('Alles zur√ºcksetzen?')){
        members=[];
        connections=[];
        snapshots=[{id:Date.now(),name:'Ausgangssituation',timestamp:new Date().toLocaleString('de-DE'),members:[],connections:[]}];
        reflexionAnswers=[];
        nextId=1;
        nextConnectionId=1;
        personCounter=1;
        currentSnapshotIndex=0;
        history=[];
        historyIndex=-1;
        panOffset={x:0,y:0};
        cancelPositionMode();
        applyPan();
        render();
        saveToLocalStorage();
        closeAllDrawers();
        showNotification('üîÑ Reset!');
    }
}

// ========== STORAGE ==========

function saveToLocalStorage(){
    const data={
        members:members,
        connections:connections,
        snapshots:snapshots,
        reflexions:reflexionAnswers,
        sessions:sessions,
        nextId:nextId,
        nextConnectionId:nextConnectionId,
        personCounter:personCounter,
        panOffset:panOffset
    };
    localStorage.setItem('reflexionsRadarMobile',JSON.stringify(data));
}

function loadFromLocalStorage(){
    const stored=localStorage.getItem('reflexionsRadarMobile');
    if(stored){
        try{
            const data=JSON.parse(stored);
            members=data.members||[];
            connections=data.connections||[];
            snapshots=data.snapshots||[];
            reflexionAnswers=data.reflexions||[];
            sessions=data.sessions||[];
            nextId=data.nextId||1;
            nextConnectionId=data.nextConnectionId||1;
            personCounter=data.personCounter||1;
            
            if(data.panOffset){
                panOffset=data.panOffset;
            }
            
            if(members.length>0||connections.length>0){
                history=[{
                    members:JSON.parse(JSON.stringify(members)),
                    connections:JSON.parse(JSON.stringify(connections))
                }];
                historyIndex=0;
            }
        }catch(err){
            console.error('Error loading data:',err);
        }
    }
}

// Make functions globally accessible
window.selectScaling=selectScaling;

init();
    </script>
</body>
</html>
